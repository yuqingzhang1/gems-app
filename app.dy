import streamlit as st
import google.generativeai as genai
import json
import os

# --- é¡µé¢é…ç½® ---
st.set_page_config(page_title="GEMS Studio", layout="wide")

# --- ä¾§è¾¹æ ï¼šè¾“å…¥ API Key ---
with st.sidebar:
    st.title("âš™ï¸ è®¾ç½®")
    # ä¸ºäº†å®‰å…¨ï¼Œå…è®¸ç”¨æˆ·åœ¨ç•Œé¢è¾“å…¥ Keyï¼Œæˆ–è€…ä» Secrets è¯»å–
    api_key = st.text_input("è¾“å…¥ Google AI Studio API Key", type="password")
    if not api_key and "GOOGLE_API_KEY" in st.secrets:
        api_key = st.secrets["GOOGLE_API_KEY"]

# --- ä¸»ç•Œé¢ ---
st.title("ğŸ¬ [CN x PI] GEMS Studio")
st.caption("åŸºäº Gemini Pro çš„è§†é¢‘ç­–åˆ’åŠ©æ‰‹")

# å¦‚æœæ²¡æœ‰ Keyï¼Œæç¤ºç”¨æˆ·
if not api_key:
    st.warning("è¯·åœ¨å·¦ä¾§ä¾§è¾¹æ è¾“å…¥ API Key æ‰èƒ½å¼€å§‹ã€‚")
    st.stop()

# --- é…ç½® Gemini ---
genai.configure(api_key=api_key)

# è®¾ç½® System Prompt (ä½ çš„æ ¸å¿ƒé€»è¾‘)
system_instruction = """
ä½ æ˜¯ä¸€ä¸ªè§†é¢‘åˆ¶ä½œå¯¼æ¼”ã€‚
ç”¨æˆ·ä¼šç»™ä½ ä¸€ä¸ªä¸»é¢˜ï¼Œè¯·ä½ ç”Ÿæˆä¸€ä¸ªåŒ…å«3ä¸ªåœºæ™¯çš„åˆ†é•œè„šæœ¬ã€‚
è¯·ç›´æ¥è¿”å› JSON æ ¼å¼ï¼Œä¸è¦åŒ…å« Markdown æ ‡è®°ã€‚
æ ¼å¼ï¼š[{"scene": 1, "desc": "ç”»é¢æè¿°", "audio": "æ—ç™½"}]
"""

# åˆå§‹åŒ–æ¨¡å‹
model = genai.GenerativeModel(
    model_name="gemini-1.5-pro-latest",
    system_instruction=system_instruction
)

# --- èŠå¤©é€»è¾‘ ---
if "messages" not in st.session_state:
    st.session_state.messages = []

# æ˜¾ç¤ºå†å²æ¶ˆæ¯
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# æ¥æ”¶ç”¨æˆ·è¾“å…¥
if prompt := st.chat_input("æˆ‘æƒ³åšä¸€ä¸ªå…³äº...çš„è§†é¢‘"):
    # 1. æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    st.chat_message("user").markdown(prompt)
    st.session_state.messages.append({"role": "user", "content": prompt})

    # 2. è°ƒç”¨ Gemini
    with st.chat_message("assistant"):
        with st.spinner("å¯¼æ¼”æ­£åœ¨æ€è€ƒåˆ†é•œ..."):
            try:
                # å‘é€è¯·æ±‚
                response = model.generate_content(prompt)
                result_text = response.text
                
                # å°è¯•è§£æ JSON (ä¸ºäº†å±•ç¤ºå¥½çœ‹çš„å¡ç‰‡)
                try:
                    # æ¸…ç†å¯èƒ½å­˜åœ¨çš„ markdown ç¬¦å·
                    clean_json = result_text.replace("```json", "").replace("```", "")
                    script_data = json.loads(clean_json)
                    
                    st.success("âœ… åˆ†é•œè„šæœ¬å·²ç”Ÿæˆ")
                    
                    # ä»¥å¡ç‰‡å½¢å¼å±•ç¤º
                    cols = st.columns(len(script_data))
                    for idx, scene in enumerate(script_data):
                        with cols[idx]:
                            st.info(f"åœºæ™¯ {scene.get('scene')}")
                            st.write(f"ğŸ–¼ï¸ **ç”»é¢:** {scene.get('desc')}")
                            st.caption(f"ğŸ”Š **æ—ç™½:** {scene.get('audio')}")
                            st.image("https://via.placeholder.com/300x200?text=Generating...", caption="Image Placeholder")
                    
                    # ä¿å­˜åŸå§‹æ–‡æœ¬åˆ°å†å²
                    st.session_state.messages.append({"role": "assistant", "content": "å·²ç”Ÿæˆåˆ†é•œå¡ç‰‡ğŸ‘†"})
                    
                except json.JSONDecodeError:
                    # å¦‚æœä¸æ˜¯ JSONï¼Œç›´æ¥æ˜¾ç¤ºæ–‡æœ¬
                    st.markdown(result_text)
                    st.session_state.messages.append({"role": "assistant", "content": result_text})
                    
            except Exception as e:
                st.error(f"å‡ºé”™äº†: {e}")
